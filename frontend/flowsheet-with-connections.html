<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSim - Process Flowsheet Designer with Stream Connections</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f8fafc;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Toolbar */
        .toolbar {
            width: 280px;
            background: white;
            border-right: 2px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .toolbar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }

        .toolbar-header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .unit-palette {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .palette-section {
            margin-bottom: 25px;
        }

        .palette-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 12px;
            text-transform: uppercase;
        }

        .unit-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .unit-item:hover {
            border-color: #8b5cf6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }

        .unit-icon {
            width: 32px;
            height: 32px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 16px;
        }

        .unit-info {
            flex: 1;
        }

        .unit-name {
            font-weight: 500;
            color: #1e293b;
            font-size: 13px;
        }

        .unit-desc {
            font-size: 11px;
            color: #64748b;
            margin-top: 2px;
        }

        /* Canvas */
        .canvas-container {
            flex: 1;
            position: relative;
            background: linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px),
                        linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .canvas {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: auto;
        }

        .unit-node {
            position: absolute;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            min-width: 120px;
            cursor: move;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            user-select: none;
        }

        .unit-node:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .unit-node.selected {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .unit-node.dragging {
            z-index: 1000;
            transform: rotate(2deg);
        }

        /* Connection ports */
        .connection-port {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: crosshair;
            transition: all 0.2s ease;
            z-index: 5;
        }

        .connection-port:hover {
            transform: scale(1.3);
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .connection-port.inlet {
            background: #10b981;
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connection-port.outlet {
            background: #f59e0b;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connection-port.top {
            background: #60a5fa;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .connection-port.bottom {
            background: #f87171;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .connection-port.active {
            background: #8b5cf6;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Distillation column specific */
        .distillation-column {
            width: 140px;
            height: 180px;
            background: linear-gradient(to bottom, #e0e7ff, #c7d2fe);
            border: 2px solid #7c3aed;
        }

        .column-visual {
            width: 60px;
            height: 120px;
            background: linear-gradient(to bottom, #ddd6fe, #a78bfa);
            margin: 20px auto 10px;
            border-radius: 4px;
            position: relative;
            border: 1px solid #7c3aed;
        }

        .column-tray {
            position: absolute;
            width: 100%;
            height: 1px;
            background: #6d28d9;
        }

        .column-condenser {
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            background: #60a5fa;
            border-radius: 2px;
        }

        .column-reboiler {
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            background: #f87171;
            border-radius: 2px;
        }

        /* Stream connections */
        .stream-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .stream-line {
            stroke: #475569;
            stroke-width: 3;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .stream-line.selected {
            stroke: #8b5cf6;
            stroke-width: 4;
        }

        .stream-line.temp-line {
            stroke: #ef4444;
            stroke-dasharray: 5,5;
            animation: dash 1s linear infinite;
        }

        @keyframes dash {
            to { stroke-dashoffset: -10; }
        }

        .stream-label {
            font-size: 10px;
            fill: #475569;
            text-anchor: middle;
            pointer-events: none;
        }

        .node-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .node-title {
            font-weight: 600;
            font-size: 12px;
            color: #1e293b;
            margin-left: 8px;
        }

        .node-type {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
            margin-left: 8px;
        }

        /* Properties Panel */
        .properties-panel {
            width: 350px;
            background: white;
            border-left: 2px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }

        .properties-header {
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .properties-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .property-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid #8b5cf6;
        }

        .property-group h4 {
            font-size: 12px;
            font-weight: 600;
            color: #7c3aed;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .property-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
        }

        .property-label {
            font-size: 12px;
            color: #475569;
            font-weight: 500;
        }

        .property-input {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            width: 80px;
            text-align: right;
        }

        .property-input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1);
        }

        /* Control buttons */
        .control-bar {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 5;
        }

        .control-btn {
            padding: 10px 15px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #475569;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-btn:hover {
            border-color: #8b5cf6;
            color: #7c3aed;
        }

        .control-btn.active {
            background: #8b5cf6;
            color: white;
            border-color: #7c3aed;
        }

        .simulate-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-color: #059669;
        }

        .simulate-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .simulate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #64748b;
            pointer-events: none;
        }

        .empty-state div:first-child {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .connection-mode-info {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(139, 92, 246, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 10;
            display: none;
        }

        .connection-mode-info.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Unit Operations Toolbar -->
        <div class="toolbar">
            <div class="toolbar-header">
                <h1>üß™ DeepSim</h1>
                <p>Process Flowsheet Designer</p>
            </div>
            
            <div class="unit-palette">
                <div class="palette-section">
                    <h3>Separations</h3>
                    <div class="unit-item" data-unit-type="DistillationColumn">
                        <div class="unit-icon" style="background-color: rgba(124, 58, 237, 0.2); color: #7c3aed;">üèóÔ∏è</div>
                        <div class="unit-info">
                            <div class="unit-name">Distillation Column</div>
                            <div class="unit-desc">Rigorous MESH solver</div>
                        </div>
                    </div>
                    <div class="unit-item" data-unit-type="Flash">
                        <div class="unit-icon" style="background-color: rgba(236, 72, 153, 0.2); color: #ec4899;">‚ö°</div>
                        <div class="unit-info">
                            <div class="unit-name">Flash Drum</div>
                            <div class="unit-desc">Vapor-liquid separator</div>
                        </div>
                    </div>
                </div>

                <div class="palette-section">
                    <h3>Reactors</h3>
                    <div class="unit-item" data-unit-type="CSTR">
                        <div class="unit-icon" style="background-color: rgba(16, 185, 129, 0.2); color: #10b981;">üß™</div>
                        <div class="unit-info">
                            <div class="unit-name">CSTR</div>
                            <div class="unit-desc">Continuous stirred tank</div>
                        </div>
                    </div>
                </div>

                <div class="palette-section">
                    <h3>Heat Transfer</h3>
                    <div class="unit-item" data-unit-type="Heater">
                        <div class="unit-icon" style="background-color: rgba(220, 38, 38, 0.2); color: #dc2626;">üî•</div>
                        <div class="unit-info">
                            <div class="unit-name">Heater</div>
                            <div class="unit-desc">Heat addition</div>
                        </div>
                    </div>
                    <div class="unit-item" data-unit-type="Cooler">
                        <div class="unit-icon" style="background-color: rgba(37, 99, 235, 0.2); color: #2563eb;">‚ùÑÔ∏è</div>
                        <div class="unit-info">
                            <div class="unit-name">Cooler</div>
                            <div class="unit-desc">Heat removal</div>
                        </div>
                    </div>
                </div>

                <div class="palette-section">
                    <h3>Pressure Change</h3>
                    <div class="unit-item" data-unit-type="Pump">
                        <div class="unit-icon" style="background-color: rgba(124, 45, 18, 0.2); color: #7c2d12;">‚¨ÜÔ∏è</div>
                        <div class="unit-info">
                            <div class="unit-name">Pump</div>
                            <div class="unit-desc">Liquid pressure increase</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Canvas -->
        <div class="canvas-container">
            <div class="canvas" id="canvas">
                <!-- SVG for stream connections -->
                <svg class="stream-svg" id="streamSvg">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#475569" />
                        </marker>
                    </defs>
                </svg>

                <div class="empty-state">
                    <div>üéØ</div>
                    <p>Drag unit operations from the left panel to start designing</p>
                    <p style="font-size: 11px; margin-top: 8px;">Use Connect mode to draw streams between units</p>
                </div>
            </div>

            <!-- Control Bar -->
            <div class="control-bar">
                <button class="control-btn" id="connectBtn" onclick="toggleConnectionMode()">
                    üîó Connect
                </button>
                <button class="control-btn" onclick="clearFlowsheet()">üóëÔ∏è Clear</button>
                <button class="control-btn simulate-btn" onclick="runSimulation()" id="simulateBtn">
                    üöÄ Simulate
                </button>
            </div>

            <!-- Connection Mode Info -->
            <div class="connection-mode-info" id="connectionInfo">
                <div>üîó <strong>Connection Mode Active</strong></div>
                <div>Click on output ports (right side) then input ports (left side) to connect units</div>
                <div>Click "Connect" again to exit</div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar" id="statusBar">
                Ready to design your process flowsheet
            </div>
        </div>

        <!-- Properties Panel -->
        <div class="properties-panel">
            <div class="properties-header">
                <h3 id="propertiesTitle">Select a Unit Operation</h3>
            </div>
            
            <div class="properties-content" id="propertiesContent">
                <div style="text-align: center; color: #64748b; padding: 40px 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚öôÔ∏è</div>
                    <p>Click on a unit operation to configure its properties</p>
                    <p style="font-size: 12px; margin-top: 8px;">
                        Use üîó Connect mode to draw streams between units
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let units = [];
        let streams = [];
        let selectedUnit = null;
        let flowsheetId = null;
        let unitCounter = 0;
        let streamCounter = 0;
        let isConnectionMode = false;
        let selectedPort = null;
        let tempLine = null;

        // Unit definitions
        const unitDefinitions = {
            'DistillationColumn': { name: 'Distillation Column', icon: 'üèóÔ∏è', color: '#7c3aed' },
            'Flash': { name: 'Flash Drum', icon: '‚ö°', color: '#ec4899' },
            'CSTR': { name: 'CSTR', icon: 'üß™', color: '#10b981' },
            'Heater': { name: 'Heater', icon: 'üî•', color: '#dc2626' },
            'Cooler': { name: 'Cooler', icon: '‚ùÑÔ∏è', color: '#2563eb' },
            'Pump': { name: 'Pump', icon: '‚¨ÜÔ∏è', color: '#7c2d12' }
        };

        // Initialize drag and drop
        function initializeDragDrop() {
            const unitItems = document.querySelectorAll('.unit-item');
            const canvas = document.getElementById('canvas');

            unitItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (isConnectionMode) return;
                    const unitType = item.dataset.unitType;
                    addUnitToCanvas(unitType, { x: 300 + Math.random() * 200, y: 200 + Math.random() * 200 });
                });

                // Make draggable
                item.draggable = true;
                item.addEventListener('dragstart', (e) => {
                    if (isConnectionMode) {
                        e.preventDefault();
                        return;
                    }
                    e.dataTransfer.setData('text/plain', item.dataset.unitType);
                });
            });

            // Canvas drop handling
            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            canvas.addEventListener('drop', (e) => {
                if (isConnectionMode) return;
                e.preventDefault();
                const unitType = e.dataTransfer.getData('text/plain');
                const rect = canvas.getBoundingClientRect();
                const position = {
                    x: e.clientX - rect.left + canvas.scrollLeft,
                    y: e.clientY - rect.top + canvas.scrollTop
                };
                addUnitToCanvas(unitType, position);
            });
        }

        // Toggle connection mode
        function toggleConnectionMode() {
            isConnectionMode = !isConnectionMode;
            const connectBtn = document.getElementById('connectBtn');
            const connectionInfo = document.getElementById('connectionInfo');
            
            if (isConnectionMode) {
                connectBtn.classList.add('active');
                connectBtn.textContent = '‚ùå Exit Connect';
                connectionInfo.classList.add('show');
                updateStatus('üîó Connection mode: Click output ports, then input ports');
                
                // Make ports visible and interactive
                document.querySelectorAll('.connection-port').forEach(port => {
                    port.style.opacity = '1';
                });
            } else {
                connectBtn.classList.remove('active');
                connectBtn.textContent = 'üîó Connect';
                connectionInfo.classList.remove('show');
                updateStatus('Connection mode disabled');
                
                // Reset any active selections
                resetConnectionState();
            }
        }

        // Reset connection state
        function resetConnectionState() {
            selectedPort = null;
            if (tempLine) {
                tempLine.remove();
                tempLine = null;
            }
            document.querySelectorAll('.connection-port.active').forEach(port => {
                port.classList.remove('active');
            });
        }

        // Add unit to canvas
        function addUnitToCanvas(unitType, position) {
            unitCounter++;
            const unitDef = unitDefinitions[unitType];
            
            const unit = {
                id: `${unitType.toLowerCase()}_${unitCounter}`,
                type: unitType,
                name: `${unitDef.name} ${unitCounter}`,
                position: position,
                parameters: unitType === 'DistillationColumn' ? {
                    stages: 20,
                    refluxRatio: 2.0,
                    feedStage: 10,
                    distillateRate: 50,
                    pressure: 101325,
                    trayEfficiency: 0.75,
                    feed_benzene: 0.6,
                    feed_toluene: 0.4
                } : {}
            };

            units.push(unit);
            renderUnit(unit);
            updateStatus(`Added ${unitDef.name} to flowsheet`);
            
            // Hide empty state
            const emptyState = document.querySelector('.empty-state');
            if (emptyState) emptyState.style.display = 'none';
        }

        // Render unit on canvas
        function renderUnit(unit) {
            const canvas = document.getElementById('canvas');
            const unitDef = unitDefinitions[unit.type];
            
            const unitElement = document.createElement('div');
            unitElement.className = 'unit-node';
            unitElement.id = unit.id;
            unitElement.style.left = unit.position.x + 'px';
            unitElement.style.top = unit.position.y + 'px';
            unitElement.style.borderColor = unitDef.color;

            if (unit.type === 'DistillationColumn') {
                unitElement.className += ' distillation-column';
                unitElement.innerHTML = `
                    <div class="node-header">
                        <span style="font-size: 16px;">${unitDef.icon}</span>
                        <div>
                            <div class="node-title">${unit.name}</div>
                            <div class="node-type">Column</div>
                        </div>
                    </div>
                    <div class="column-visual">
                        <div class="column-condenser"></div>
                        <div class="column-tray" style="top: 10%"></div>
                        <div class="column-tray" style="top: 25%"></div>
                        <div class="column-tray" style="top: 40%"></div>
                        <div class="column-tray" style="top: 55%"></div>
                        <div class="column-tray" style="top: 70%"></div>
                        <div class="column-tray" style="top: 85%"></div>
                        <div class="column-reboiler"></div>
                    </div>
                    
                    <!-- Connection ports for distillation column -->
                    <div class="connection-port inlet" data-port="feed" data-unit="${unit.id}"></div>
                    <div class="connection-port top" data-port="condenser" data-unit="${unit.id}" style="left: 25%;"></div>
                    <div class="connection-port bottom" data-port="reboiler" data-unit="${unit.id}" style="left: 25%;"></div>
                    <div class="connection-port top outlet" data-port="distillate" data-unit="${unit.id}" style="left: 75%; background: #10b981;"></div>
                    <div class="connection-port bottom outlet" data-port="bottoms" data-unit="${unit.id}" style="left: 75%; background: #f59e0b;"></div>
                `;
            } else {
                unitElement.innerHTML = `
                    <div class="node-header">
                        <span style="font-size: 16px;">${unitDef.icon}</span>
                        <div>
                            <div class="node-title">${unit.name}</div>
                            <div class="node-type">${unit.type}</div>
                        </div>
                    </div>
                    
                    <!-- Standard connection ports -->
                    <div class="connection-port inlet" data-port="inlet" data-unit="${unit.id}"></div>
                    <div class="connection-port outlet" data-port="outlet" data-unit="${unit.id}"></div>
                `;
            }

            // Add connection port event listeners
            const ports = unitElement.querySelectorAll('.connection-port');
            ports.forEach(port => {
                port.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handlePortClick(port);
                });
            });

            // Make draggable
            makeDraggable(unitElement, unit);
            
            // Make selectable
            unitElement.addEventListener('click', (e) => {
                if (isConnectionMode) return;
                e.stopPropagation();
                selectUnit(unit);
            });

            canvas.appendChild(unitElement);
        }

        // Handle port clicks for connections
        function handlePortClick(port) {
            if (!isConnectionMode) return;

            const unitId = port.dataset.unit;
            const portId = port.dataset.port;
            const isOutlet = port.classList.contains('outlet');

            if (!selectedPort) {
                // First port selected - must be an outlet
                if (!isOutlet) {
                    updateStatus('‚ùå Start connections from output ports (right side)');
                    return;
                }
                
                selectedPort = { unitId, portId, element: port };
                port.classList.add('active');
                updateStatus('‚úÖ Output selected. Now click an input port to connect');
                
                // Start drawing temporary line
                startTempLine(port);
                
            } else {
                // Second port selected - must be an inlet
                if (isOutlet) {
                    updateStatus('‚ùå Connect to input ports (left side)');
                    return;
                }
                
                if (selectedPort.unitId === unitId) {
                    updateStatus('‚ùå Cannot connect unit to itself');
                    resetConnectionState();
                    return;
                }
                
                // Create connection
                createStream(selectedPort.unitId, selectedPort.portId, unitId, portId);
                resetConnectionState();
                updateStatus('‚úÖ Stream connection created');
            }
        }

        // Start drawing temporary line
        function startTempLine(fromPort) {
            const canvas = document.getElementById('canvas');
            const svg = document.getElementById('streamSvg');
            const rect = fromPort.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            
            const startX = rect.left - canvasRect.left + rect.width/2 + canvas.scrollLeft;
            const startY = rect.top - canvasRect.top + rect.height/2 + canvas.scrollTop;
            
            tempLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            tempLine.setAttribute('x1', startX);
            tempLine.setAttribute('y1', startY);
            tempLine.setAttribute('x2', startX);
            tempLine.setAttribute('y2', startY);
            tempLine.classList.add('stream-line', 'temp-line');
            
            svg.appendChild(tempLine);
            
            // Follow mouse
            canvas.addEventListener('mousemove', updateTempLine);
        }

        // Update temporary line position
        function updateTempLine(e) {
            if (!tempLine) return;
            
            const canvas = document.getElementById('canvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left + canvas.scrollLeft;
            const y = e.clientY - rect.top + canvas.scrollTop;
            
            tempLine.setAttribute('x2', x);
            tempLine.setAttribute('y2', y);
        }

        // Create stream connection
        function createStream(fromUnit, fromPort, toUnit, toPort) {
            streamCounter++;
            
            const stream = {
                id: `stream_${streamCounter}`,
                from: { unit: fromUnit, port: fromPort },
                to: { unit: toUnit, port: toPort },
                name: `Stream ${streamCounter}`
            };
            
            streams.push(stream);
            renderStream(stream);
        }

        // Render stream connection
        function renderStream(stream) {
            const svg = document.getElementById('streamSvg');
            const canvas = document.getElementById('canvas');
            
            const fromElement = document.querySelector(`[data-unit="${stream.from.unit}"][data-port="${stream.from.port}"]`);
            const toElement = document.querySelector(`[data-unit="${stream.to.unit}"][data-port="${stream.to.port}"]`);
            
            if (!fromElement || !toElement) return;
            
            const updateStreamPosition = () => {
                const fromRect = fromElement.getBoundingClientRect();
                const toRect = toElement.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                
                const x1 = fromRect.left - canvasRect.left + fromRect.width/2 + canvas.scrollLeft;
                const y1 = fromRect.top - canvasRect.top + fromRect.height/2 + canvas.scrollTop;
                const x2 = toRect.left - canvasRect.left + toRect.width/2 + canvas.scrollLeft;
                const y2 = toRect.top - canvasRect.top + toRect.height/2 + canvas.scrollTop;
                
                // Create curved path
                const midX = (x1 + x2) / 2;
                const controlX1 = x1 + (midX - x1) * 0.5;
                const controlX2 = x2 - (x2 - midX) * 0.5;
                
                const path = `M ${x1} ${y1} C ${controlX1} ${y1}, ${controlX2} ${y2}, ${x2} ${y2}`;
                
                let pathElement = document.getElementById(`stream_${stream.id}`);
                if (!pathElement) {
                    pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    pathElement.id = `stream_${stream.id}`;
                    pathElement.classList.add('stream-line');
                    svg.appendChild(pathElement);
                }
                
                pathElement.setAttribute('d', path);
                
                // Add label
                let labelElement = document.getElementById(`label_${stream.id}`);
                if (!labelElement) {
                    labelElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    labelElement.id = `label_${stream.id}`;
                    labelElement.classList.add('stream-label');
                    labelElement.textContent = stream.name;
                    svg.appendChild(labelElement);
                }
                
                labelElement.setAttribute('x', midX);
                labelElement.setAttribute('y', (y1 + y2) / 2 - 5);
            };
            
            updateStreamPosition();
            
            // Store update function for later use
            stream.updatePosition = updateStreamPosition;
        }

        // Update all stream positions
        function updateAllStreams() {
            streams.forEach(stream => {
                if (stream.updatePosition) {
                    stream.updatePosition();
                }
            });
        }

        // Make unit draggable
        function makeDraggable(element, unit) {
            let isDragging = false;
            let offset = { x: 0, y: 0 };

            element.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'INPUT' || isConnectionMode) return;
                
                isDragging = true;
                element.classList.add('dragging');
                
                const rect = element.getBoundingClientRect();
                const canvas = document.getElementById('canvas');
                const canvasRect = canvas.getBoundingClientRect();
                
                offset.x = e.clientX - rect.left;
                offset.y = e.clientY - rect.top;

                const handleMouseMove = (e) => {
                    if (!isDragging) return;
                    
                    const newX = e.clientX - canvasRect.left + canvas.scrollLeft - offset.x;
                    const newY = e.clientY - canvasRect.top + canvas.scrollTop - offset.y;
                    
                    element.style.left = Math.max(0, newX) + 'px';
                    element.style.top = Math.max(0, newY) + 'px';
                    
                    unit.position.x = Math.max(0, newX);
                    unit.position.y = Math.max(0, newY);
                    
                    // Update stream positions
                    updateAllStreams();
                };

                const handleMouseUp = () => {
                    isDragging = false;
                    element.classList.remove('dragging');
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });
        }

        // Select unit
        function selectUnit(unit) {
            // Remove previous selection
            document.querySelectorAll('.unit-node').forEach(el => el.classList.remove('selected'));
            
            // Add selection to current unit
            document.getElementById(unit.id).classList.add('selected');
            
            selectedUnit = unit;
            updatePropertiesPanel(unit);
        }

        // Update properties panel
        function updatePropertiesPanel(unit) {
            const title = document.getElementById('propertiesTitle');
            const content = document.getElementById('propertiesContent');
            
            title.textContent = `Properties: ${unit.name}`;
            
            if (unit.type === 'DistillationColumn') {
                content.innerHTML = `
                    <div class="property-group">
                        <h4>Column Configuration</h4>
                        <div class="property-row">
                            <span class="property-label">Stages:</span>
                            <input class="property-input" type="number" value="${unit.parameters.stages}" 
                                   onchange="updateParameter('${unit.id}', 'stages', parseInt(this.value))">
                        </div>
                        <div class="property-row">
                            <span class="property-label">Reflux Ratio:</span>
                            <input class="property-input" type="number" step="0.1" value="${unit.parameters.refluxRatio}" 
                                   onchange="updateParameter('${unit.id}', 'refluxRatio', parseFloat(this.value))">
                        </div>
                        <div class="property-row">
                            <span class="property-label">Feed Stage:</span>
                            <input class="property-input" type="number" value="${unit.parameters.feedStage}" 
                                   onchange="updateParameter('${unit.id}', 'feedStage', parseInt(this.value))">
                        </div>
                    </div>

                    <div class="property-group">
                        <h4>Operating Conditions</h4>
                        <div class="property-row">
                            <span class="property-label">Distillate (kmol/h):</span>
                            <input class="property-input" type="number" step="0.1" value="${unit.parameters.distillateRate}" 
                                   onchange="updateParameter('${unit.id}', 'distillateRate', parseFloat(this.value))">
                        </div>
                        <div class="property-row">
                            <span class="property-label">Pressure (Pa):</span>
                            <input class="property-input" type="number" value="${unit.parameters.pressure}" 
                                   onchange="updateParameter('${unit.id}', 'pressure', parseInt(this.value))">
                        </div>
                        <div class="property-row">
                            <span class="property-label">Tray Efficiency:</span>
                            <input class="property-input" type="number" step="0.01" min="0.1" max="1.0" value="${unit.parameters.trayEfficiency}" 
                                   onchange="updateParameter('${unit.id}', 'trayEfficiency', parseFloat(this.value))">
                        </div>
                    </div>

                    <div class="property-group">
                        <h4>Feed Composition</h4>
                        <div class="property-row">
                            <span class="property-label">Benzene:</span>
                            <input class="property-input" type="number" step="0.01" min="0" max="1" value="${unit.parameters.feed_benzene}" 
                                   onchange="updateComposition('${unit.id}', 'benzene', parseFloat(this.value))">
                        </div>
                        <div class="property-row">
                            <span class="property-label">Toluene:</span>
                            <input class="property-input" type="number" step="0.01" min="0" max="1" value="${unit.parameters.feed_toluene}" 
                                   onchange="updateComposition('${unit.id}', 'toluene', parseFloat(this.value))">
                        </div>
                    </div>

                    <div class="property-group">
                        <h4>Stream Connections</h4>
                        <p style="font-size: 11px; color: #64748b;">
                            Feed: ${getConnectionInfo(unit.id, 'feed')}<br>
                            Distillate: ${getConnectionInfo(unit.id, 'distillate')}<br>
                            Bottoms: ${getConnectionInfo(unit.id, 'bottoms')}
                        </p>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="property-group">
                        <h4>Basic Properties</h4>
                        <div class="property-row">
                            <span class="property-label">Unit Name:</span>
                            <input class="property-input" style="width: 120px;" type="text" value="${unit.name}" 
                                   onchange="updateUnitName('${unit.id}', this.value)">
                        </div>
                        <p style="font-size: 12px; color: #64748b; margin-top: 10px;">
                            Use üîó Connect mode to connect this unit to other operations.
                        </p>
                    </div>
                    
                    <div class="property-group">
                        <h4>Stream Connections</h4>
                        <p style="font-size: 11px; color: #64748b;">
                            Inlet: ${getConnectionInfo(unit.id, 'inlet')}<br>
                            Outlet: ${getConnectionInfo(unit.id, 'outlet')}
                        </p>
                    </div>
                `;
            }
        }

        // Get connection information for a port
        function getConnectionInfo(unitId, portId) {
            const incomingStream = streams.find(s => s.to.unit === unitId && s.to.port === portId);
            const outgoingStream = streams.find(s => s.from.unit === unitId && s.from.port === portId);
            
            if (incomingStream) {
                const fromUnit = units.find(u => u.id === incomingStream.from.unit);
                return `‚Üê ${fromUnit ? fromUnit.name : 'Unknown'}`;
            } else if (outgoingStream) {
                const toUnit = units.find(u => u.id === outgoingStream.to.unit);
                return `‚Üí ${toUnit ? toUnit.name : 'Unknown'}`;
            } else {
                return 'Not connected';
            }
        }

        // Update parameter
        function updateParameter(unitId, param, value) {
            const unit = units.find(u => u.id === unitId);
            if (unit) {
                unit.parameters[param] = value;
                updateStatus(`Updated ${param} to ${value}`);
            }
        }

        // Update composition with auto-normalization
        function updateComposition(unitId, component, value) {
            const unit = units.find(u => u.id === unitId);
            if (unit) {
                if (component === 'benzene') {
                    unit.parameters.feed_benzene = value;
                    unit.parameters.feed_toluene = 1 - value;
                } else {
                    unit.parameters.feed_toluene = value;
                    unit.parameters.feed_benzene = 1 - value;
                }
                // Re-render properties to show updated values
                updatePropertiesPanel(unit);
                updateStatus(`Updated feed composition`);
            }
        }

        // Update unit name
        function updateUnitName(unitId, name) {
            const unit = units.find(u => u.id === unitId);
            if (unit) {
                unit.name = name;
                // Update the display
                const element = document.getElementById(unitId);
                const titleElement = element.querySelector('.node-title');
                if (titleElement) titleElement.textContent = name;
                updateStatus(`Renamed unit to ${name}`);
            }
        }

        // Clear flowsheet
        function clearFlowsheet() {
            units = [];
            streams = [];
            selectedUnit = null;
            flowsheetId = null;
            
            // Clear canvas
            const canvas = document.getElementById('canvas');
            const unitNodes = canvas.querySelectorAll('.unit-node');
            unitNodes.forEach(node => node.remove());
            
            // Clear streams
            const svg = document.getElementById('streamSvg');
            svg.querySelectorAll('.stream-line, .stream-label').forEach(el => el.remove());
            
            // Reset connection mode
            if (isConnectionMode) {
                toggleConnectionMode();
            }
            
            // Show empty state
            const emptyState = canvas.querySelector('.empty-state');
            if (emptyState) emptyState.style.display = 'block';
            
            // Reset properties panel
            document.getElementById('propertiesTitle').textContent = 'Select a Unit Operation';
            document.getElementById('propertiesContent').innerHTML = `
                <div style="text-align: center; color: #64748b; padding: 40px 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚öôÔ∏è</div>
                    <p>Click on a unit operation to configure its properties</p>
                    <p style="font-size: 12px; margin-top: 8px;">
                        Use üîó Connect mode to draw streams between units
                    </p>
                </div>
            `;
            
            updateStatus('Flowsheet cleared - Ready for new design');
        }

        // Run simulation
        async function runSimulation() {
            if (units.length === 0) {
                updateStatus('‚ùå Add some unit operations first!');
                return;
            }

            const simulateBtn = document.getElementById('simulateBtn');
            simulateBtn.disabled = true;
            simulateBtn.textContent = '‚öôÔ∏è Running...';
            updateStatus('üöÄ Running rigorous simulation with stream connections...');

            try {
                // Create flowsheet if needed
                let currentFlowsheetId = flowsheetId;
                if (!currentFlowsheetId) {
                    const createResponse = await fetch('http://localhost:8000/flowsheet', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: 'Connected Flowsheet',
                            description: 'Interactive flowsheet with stream connections'
                        })
                    });
                    
                    if (!createResponse.ok) throw new Error('Failed to create flowsheet');
                    
                    const createData = await createResponse.json();
                    currentFlowsheetId = createData.flowsheet_id;
                    flowsheetId = currentFlowsheetId;
                }

                // Update flowsheet with connections
                const flowsheetData = {
                    name: 'Connected Flowsheet',
                    description: 'Interactive flowsheet with stream connections',
                    units: units.map(unit => ({
                        id: unit.id,
                        type: unit.type,
                        name: unit.name,
                        parameters: unit.parameters,
                        position: unit.position
                    })),
                    streams: streams.map(stream => ({
                        id: stream.id,
                        name: stream.name,
                        temperature: 368.15,
                        pressure: 101325,
                        molar_flow: 100.0,
                        composition: {
                            benzene: 0.6,
                            toluene: 0.4
                        }
                    })),
                    connections: streams.map(stream => ({
                        from_unit: stream.from.unit,
                        to_unit: stream.to.unit,
                        from_port: stream.from.port,
                        to_port: stream.to.port
                    }))
                };

                const updateResponse = await fetch(`http://localhost:8000/flowsheet/${currentFlowsheetId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(flowsheetData)
                });

                if (!updateResponse.ok) throw new Error('Failed to update flowsheet');

                // Run simulation
                const simResponse = await fetch('http://localhost:8000/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ flowsheet_id: currentFlowsheetId })
                });

                if (!simResponse.ok) throw new Error('Simulation failed');

                const simData = await simResponse.json();
                
                if (simData.status === 'completed') {
                    const distResults = simData.results.distillation_results;
                    const hasDistillation = distResults && Object.keys(distResults).length > 0;
                    
                    if (hasDistillation) {
                        const firstColumn = Object.values(distResults)[0];
                        if (firstColumn.converged) {
                            const distillate = firstColumn.product_compositions?.distillate;
                            const benzeneRecovery = distillate?.benzene ? (distillate.benzene * 100).toFixed(1) : 'N/A';
                            updateStatus(`‚úÖ Connected flowsheet simulated! Distillate: ${benzeneRecovery}% benzene`);
                        } else {
                            updateStatus('‚ö†Ô∏è MESH solver reached max iterations - Check specifications');
                        }
                    } else {
                        updateStatus(`‚úÖ Simulation completed with ${streams.length} stream connections`);
                    }
                } else {
                    updateStatus('‚ùå Simulation failed - Check unit configurations');
                }

            } catch (error) {
                console.error('Simulation error:', error);
                updateStatus('‚ùå Connection error - Check backend server (port 8000)');
            } finally {
                simulateBtn.disabled = false;
                simulateBtn.textContent = 'üöÄ Simulate';
            }
        }

        // Update status
        function updateStatus(message) {
            document.getElementById('statusBar').textContent = message;
        }

        // Deselect unit when clicking on canvas
        document.getElementById('canvas').addEventListener('click', (e) => {
            if (e.target.id === 'canvas' && !isConnectionMode) {
                document.querySelectorAll('.unit-node').forEach(el => el.classList.remove('selected'));
                selectedUnit = null;
                document.getElementById('propertiesTitle').textContent = 'Select a Unit Operation';
                document.getElementById('propertiesContent').innerHTML = `
                    <div style="text-align: center; color: #64748b; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚öôÔ∏è</div>
                        <p>Click on a unit operation to configure its properties</p>
                        <p style="font-size: 12px; margin-top: 8px;">
                            Use üîó Connect mode to draw streams between units
                        </p>
                    </div>
                `;
            }
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            initializeDragDrop();
            updateStatus('üéØ Ready to design your process flowsheet with stream connections');
        });

        // Remove temp line on canvas click during connection mode
        document.getElementById('canvas').addEventListener('mousemove', (e) => {
            if (isConnectionMode && selectedPort && !e.target.classList.contains('connection-port')) {
                updateTempLine(e);
            }
        });

        document.getElementById('canvas').addEventListener('click', (e) => {
            if (isConnectionMode && selectedPort && e.target.id === 'canvas') {
                resetConnectionState();
                updateStatus('üîó Connection cancelled - Click output ports to start');
            }
        });
    </script>
</body>
</html>